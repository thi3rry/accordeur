<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0f17">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>Accordeur de guitare</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:#121a28; --text:#e8eefc; --muted:#9fb0d0;
      --ok:#25d366; --warn:#ffcc00; --bad:#ff4d4d; --accent:#5aa7ff;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, #16213a 0%, var(--bg) 50%);
      color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    .app{
      width:min(960px, 100%);
      display:grid; grid-template-columns: 1.2fr .8fr; gap:18px;
    }
    @media (max-width: 820px){ .app{grid-template-columns:1fr; } }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    h1{font-size:18px; margin:0 0 10px; letter-spacing:.3px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    button{
      appearance:none; border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06); color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      transition: .15s transform, .15s background;
      font-weight:600;
    }
    button:hover{ background: rgba(255,255,255,.10) }
    button:active{ transform: translateY(1px) }
    button.primary{ background: rgba(90,167,255,.22); border-color: rgba(90,167,255,.45) }
    button.primary:hover{ background: rgba(90,167,255,.30) }
    .pill{
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size:12px;
    }
    select{
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-weight:600;
    }
    .readout{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:16px;
      align-items:center;
      margin-top:14px;
    }
    .note{
      width:140px; height:140px; border-radius: 26px;
      background: radial-gradient(140px 140px at 30% 20%, rgba(90,167,255,.35), rgba(0,0,0,.25));
      border:1px solid rgba(255,255,255,.10);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    .note .big{ font-size:54px; font-weight:800; line-height:1 }
    .note .sub{ margin-top:6px; font-size:14px; color:var(--muted) }
    .stats{
      display:grid; gap:10px;
    }
    .stat{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      font-size:14px;
    }
    .stat span{ color:var(--muted); font-size:12px }
    .meter{
      margin-top:16px;
      padding:14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
    }
    .meterTop{
      display:flex; justify-content:space-between; align-items:flex-end;
      margin-bottom:10px;
    }
    .meterTop .label{ font-weight:800; letter-spacing:.2px }
    .meterTop .hint{ color:var(--muted); font-size:12px }
    .bar{
      position:relative;
      height:14px; border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
    }
    .bar .center{
      position:absolute; left:50%; top:0; bottom:0;
      width:2px; background: rgba(255,255,255,.35);
      transform: translateX(-1px);
    }
    .bar .zoneOk{
      position:absolute; left:50%; top:0; bottom:0;
      width:22%;
      transform: translateX(-50%);
      background: rgba(37,211,102,.20);
    }
    .needle{
      position:absolute; top:-8px;
      width:0; height:0;
      border-left:8px solid transparent;
      border-right:8px solid transparent;
      border-bottom:12px solid var(--accent);
      transform: translateX(-8px);
      left:50%;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
      transition: left .08s linear;
    }
    .status{
      margin-top:10px;
      display:flex; justify-content:space-between; gap:10px;
      color:var(--muted); font-size:12px;
    }
    .status strong{ color: var(--text) }
    .strings{
      display:grid; gap:10px;
      margin-top:10px;
    }
    .stringBtn{
      width:100%;
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      text-align:left;
    }
    .stringBtn .left{
      display:flex; flex-direction:column; gap:2px;
    }
    .stringBtn .left b{ font-size:14px }
    .stringBtn .left small{ color:var(--muted) }
    .badge{
      font-size:12px; padding:6px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      background: rgba(255,255,255,.06);
      min-width: 92px; text-align:center;
    }
    .badge.ok{ color: var(--ok); border-color: rgba(37,211,102,.35); background: rgba(37,211,102,.10) }
    .badge.warn{ color: var(--warn); border-color: rgba(255,204,0,.35); background: rgba(255,204,0,.10) }
    .badge.bad{ color: var(--bad); border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.10) }
    .footer{
      margin-top:12px; color:var(--muted); font-size:12px; line-height:1.35
    }
    .err{
      margin-top:10px; color: var(--bad); font-size:12px;
    }
  </style>
</head>

<body>
  <div class="app">
    <section class="card">
      <h1>Accordeur de guitare</h1>
      <div class="row">
        <button id="btnStart" class="primary">Activer le micro</button>
        <button id="btnStop">Stop</button>

        <div class="pill" id="pillState">État : inactif</div>

        <label class="pill" style="display:flex; gap:8px; align-items:center">
          Référence
          <select id="refA">
            <option value="440">A4 = 440 Hz</option>
            <option value="442">A4 = 442 Hz</option>
            <option value="432">A4 = 432 Hz</option>
          </select>
        </label>
      </div>

      <div class="readout">
        <div class="note">
          <div class="big" id="noteName">—</div>
          <div class="sub" id="noteOct">—</div>
        </div>

        <div class="stats">
          <div class="stat"><span>Fréquence détectée</span><b id="freq">—</b></div>
          <div class="stat"><span>Cible</span><b id="target">—</b></div>
          <div class="stat"><span>Écart</span><b id="cents">—</b></div>
          <div class="stat"><span>Confiance</span><b id="conf">—</b></div>
        </div>
      </div>

      <div class="meter">
        <div class="meterTop">
          <div class="label" id="tuneLabel">—</div>
          <div class="hint">-50 cents ↔ +50 cents</div>
        </div>

        <div class="bar">
          <div class="zoneOk"></div>
          <div class="center"></div>
          <div class="needle" id="needle"></div>
        </div>

        <div class="status">
          <div>Bas</div>
          <div><strong id="statusText">—</strong></div>
          <div>Haut</div>
        </div>
      </div>

      <div class="footer">
        Conseils : joue une corde seule, évite le bruit ambiant, rapproche-toi du micro.
        Sur mobile, utilise Safari/Chrome récent. Nécessite HTTPS ou localhost.
      </div>
      <div class="err" id="err"></div>
    </section>

    <aside class="card">
      <h1>Mode guitare (standard)</h1>
      <div class="footer" style="margin-top:0">
        Sélectionne une corde pour forcer la cible. Sinon, l’accordeur “libre” choisit la note la plus proche.
      </div>

      <div class="strings" id="strings"></div>
    </aside>
  </div>

<script>
(() => {
  // -----------------------------
  // UI
  // -----------------------------
  const $ = (id) => document.getElementById(id);
  const ui = {
    btnStart: $("btnStart"),
    btnStop: $("btnStop"),
    pillState: $("pillState"),
    refA: $("refA"),
    noteName: $("noteName"),
    noteOct: $("noteOct"),
    freq: $("freq"),
    target: $("target"),
    cents: $("cents"),
    conf: $("conf"),
    tuneLabel: $("tuneLabel"),
    statusText: $("statusText"),
    needle: $("needle"),
    strings: $("strings"),
    err: $("err"),
  };

  // -----------------------------
  // Tuning targets (standard)
  // -----------------------------
  const STRING_TARGETS = [
    { label: "E", octave: 2, name: "Mi grave", freq: 82.4069 },
    { label: "A", octave: 2, name: "La",      freq: 110.0000 },
    { label: "D", octave: 3, name: "Ré",      freq: 146.8324 },
    { label: "G", octave: 3, name: "Sol",     freq: 195.9977 },
    { label: "B", octave: 3, name: "Si",      freq: 246.9417 },
    { label: "E", octave: 4, name: "Mi aigu", freq: 329.6276 },
  ];

  let forcedTargetHz = null;

  function renderStrings() {
    ui.strings.innerHTML = "";
    STRING_TARGETS.forEach((s, idx) => {
      const btn = document.createElement("button");
      btn.className = "stringBtn";
      btn.type = "button";
      btn.innerHTML = `
        <div class="left">
          <b>${s.label}${s.octave}</b>
          <small>${s.name} • ${s.freq.toFixed(2)} Hz</small>
        </div>
        <div class="badge" id="badge-${idx}">Cible</div>
      `;
      btn.addEventListener("click", () => {
        forcedTargetHz = s.freq;
        updateTargetUI();
      });
      ui.strings.appendChild(btn);
    });

    const clear = document.createElement("button");
    clear.className = "stringBtn";
    clear.type = "button";
    clear.innerHTML = `
      <div class="left">
        <b>Mode libre</b>
        <small>Choix automatique de la note la plus proche</small>
      </div>
      <div class="badge">Auto</div>
    `;
    clear.addEventListener("click", () => {
      forcedTargetHz = null;
      updateTargetUI();
    });
    ui.strings.appendChild(clear);

    updateTargetUI();
  }

  function updateTargetUI() {
    // Purement informatif : aucune “selection state” complexe.
    // On met à jour le libellé central.
    if (forcedTargetHz) {
      const n = freqToNote(forcedTargetHz, Number(ui.refA.value));
      ui.tuneLabel.textContent = `Cible : ${n.name}${n.octave} (${forcedTargetHz.toFixed(2)} Hz)`;
    } else {
      ui.tuneLabel.textContent = "Cible : automatique";
    }
  }

  renderStrings();

  // -----------------------------
  // Audio
  // -----------------------------
  let audioCtx = null;
  let analyser = null;
  let mediaStream = null;
  let rafId = null;

  // A simple smoothing strategy:
  let lastStableHz = 0;
  let lastNote = null;

  ui.btnStart.addEventListener("click", start);
  ui.btnStop.addEventListener("click", stop);
  ui.refA.addEventListener("change", () => {
    updateTargetUI();
  });

  async function start() {
    ui.err.textContent = "";
    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: false,
          noiseSuppression: false,
          autoGainControl: false
        }
      });

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioCtx.createMediaStreamSource(mediaStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      analyser.smoothingTimeConstant = 0.0;
      source.connect(analyser);

      ui.pillState.textContent = "État : écoute";
      loop();
    } catch (e) {
      ui.err.textContent = "Micro indisponible. Vérifie les permissions et utilise HTTPS/localhost.";
      ui.pillState.textContent = "État : erreur";
    }
  }

  function stop() {
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    if (mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
    }
    if (audioCtx) {
      audioCtx.close();
      audioCtx = null;
    }
    analyser = null;
    lastStableHz = 0;
    lastNote = null;

    ui.pillState.textContent = "État : inactif";
    setUIIdle();
  }

  function setUIIdle() {
    ui.noteName.textContent = "—";
    ui.noteOct.textContent = "—";
    ui.freq.textContent = "—";
    ui.target.textContent = "—";
    ui.cents.textContent = "—";
    ui.conf.textContent = "—";
    ui.statusText.textContent = "—";
    ui.needle.style.left = "50%";
  }

  // -----------------------------
  // Pitch detection (autocorrelation)
  // -----------------------------
  function loop() {
    rafId = requestAnimationFrame(loop);
    if (!analyser || !audioCtx) return;

    const buf = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buf);

    const { frequency, confidence } = detectPitchAutocorr(buf, audioCtx.sampleRate);

    // Gate: reject low confidence or out-of-range for guitar
    const inRange = frequency > 60 && frequency < 1200;
    if (!frequency || confidence < 0.55 || !inRange) {
      ui.conf.textContent = confidence ? `${Math.round(confidence * 100)}%` : "—";
      ui.statusText.textContent = "Signal faible";
      ui.needle.style.left = "50%";
      return;
    }

    // Stabilize: simple low-pass on frequency
    const alpha = 0.20;
    lastStableHz = lastStableHz ? (lastStableHz * (1 - alpha) + frequency * alpha) : frequency;

    const A4 = Number(ui.refA.value);

    // Determine target
    const detectedNote = freqToNote(lastStableHz, A4);

    const targetHz = forcedTargetHz
      ? forcedTargetHz
      : noteToFreq(detectedNote.midi, A4);

    const cents = centsOffFromFreq(lastStableHz, targetHz);

    // Update UI
    ui.noteName.textContent = detectedNote.name;
    ui.noteOct.textContent = `Octave ${detectedNote.octave}`;
    ui.freq.textContent = `${lastStableHz.toFixed(2)} Hz`;
    ui.target.textContent = `${targetHz.toFixed(2)} Hz`;
    ui.cents.textContent = `${cents.toFixed(1)} cents`;
    ui.conf.textContent = `${Math.round(confidence * 100)}%`;

    // Status + needle
    const clamped = clamp(cents, -50, 50);
    const pct = (clamped + 50) / 100; // 0..1
    ui.needle.style.left = `${pct * 100}%`;

    const abs = Math.abs(cents);
    if (abs <= 5) {
      ui.statusText.textContent = "Accordé";
      ui.statusText.style.color = getCSS("--ok");
    } else if (abs <= 15) {
      ui.statusText.textContent = cents < 0 ? "Trop bas" : "Trop haut";
      ui.statusText.style.color = getCSS("--warn");
    } else {
      ui.statusText.textContent = cents < 0 ? "Beaucoup trop bas" : "Beaucoup trop haut";
      ui.statusText.style.color = getCSS("--bad");
    }

    // Update tune label (context)
    if (!forcedTargetHz) {
      ui.tuneLabel.textContent = `Auto : ${detectedNote.name}${detectedNote.octave}`;
    } else {
      const tn = freqToNote(forcedTargetHz, A4);
      ui.tuneLabel.textContent = `Cible : ${tn.name}${tn.octave} (${forcedTargetHz.toFixed(2)} Hz)`;
    }

    lastNote = detectedNote;
  }

  function detectPitchAutocorr(buffer, sampleRate) {
    // Remove DC offset and compute RMS
    let rms = 0;
    let mean = 0;
    for (let i = 0; i < buffer.length; i++) mean += buffer[i];
    mean /= buffer.length;

    const buf = new Float32Array(buffer.length);
    for (let i = 0; i < buffer.length; i++) {
      const v = buffer[i] - mean;
      buf[i] = v;
      rms += v * v;
    }
    rms = Math.sqrt(rms / buf.length);

    // Gate: too quiet
    if (rms < 0.01) return { frequency: 0, confidence: 0 };

    // Autocorrelation
    const size = buf.length;
    const maxLag = Math.floor(sampleRate / 60);   // ~60 Hz min
    const minLag = Math.floor(sampleRate / 1200); // ~1200 Hz max
    const corr = new Float32Array(maxLag + 1);

    for (let lag = minLag; lag <= maxLag; lag++) {
      let sum = 0;
      for (let i = 0; i < size - lag; i++) sum += buf[i] * buf[i + lag];
      corr[lag] = sum;
    }

    // Find peak lag
    let bestLag = 0;
    let bestVal = -Infinity;

    // Skip the very small lags (already minLag) and find maximum
    for (let lag = minLag; lag <= maxLag; lag++) {
      if (corr[lag] > bestVal) {
        bestVal = corr[lag];
        bestLag = lag;
      }
    }

    if (!bestLag || bestVal <= 0) return { frequency: 0, confidence: 0 };

    // Parabolic interpolation for better precision:
    const x0 = bestLag > minLag ? bestLag - 1 : bestLag;
    const x2 = bestLag < maxLag ? bestLag + 1 : bestLag;
    const y0 = corr[x0], y1 = corr[bestLag], y2 = corr[x2];

    const denom = (2 * y1 - y0 - y2);
    const shift = denom !== 0 ? (y2 - y0) / (2 * denom) : 0;

    const refinedLag = bestLag + shift;
    const frequency = sampleRate / refinedLag;

    // Confidence heuristic: normalized peak vs RMS
    // (Not a strict probability, but usable as quality indicator.)
    const confidence = clamp(bestVal / (size * rms * rms), 0, 1);

    return { frequency, confidence };
  }

  // -----------------------------
  // Note helpers
  // -----------------------------
  const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

  function freqToNote(freq, A4=440) {
    const midi = Math.round(69 + 12 * Math.log2(freq / A4));
    const name = NOTE_NAMES[(midi + 1200) % 12];
    const octave = Math.floor(midi / 12) - 1;
    return { midi, name, octave };
  }

  function noteToFreq(midi, A4=440) {
    return A4 * Math.pow(2, (midi - 69) / 12);
  }

  function centsOffFromFreq(freq, targetFreq) {
    return 1200 * Math.log2(freq / targetFreq);
  }

  // -----------------------------
  // Utils
  // -----------------------------
  function clamp(x, a, b) { return Math.max(a, Math.min(b, x)); }
  function getCSS(varName){
    return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  }
})();
</script>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js");
    });
  }
</script>
</body>
</html>
